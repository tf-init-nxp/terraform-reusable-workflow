name: 'Terraform Pull Request Task'

on:
  workflow_call:
    inputs:
      terraform_version:
        description: 'Terraform Version to be used'
        required: true
        type: string

permissions:
  id-token: write 
  contents: read
  pull-requests: write
  issues: write

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  
jobs:
  terraform-pull-request:
    name: 'Terraform Pull Request'
    runs-on: ubuntu-latest
    env:
      ARM_SKIP_PROVIDER_REGISTRATION: true
      TEMP_SECRET: ${{ secrets.TEMP_SECRET }}
#    defaults:
#      run:
#        working-directory: ${{ env.tf_actions_working_dir }}
#    permissions:
#      pull-requests: write
    steps:
    - uses: actions/checkout@v3
    - uses: hashicorp/setup-terraform@v2
      with:
        terraform_wrapper: false

    - name: Getting Branch
      id: getting-branch
      run: |
        echo "BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> "$GITHUB_ENV"
        
        
    - name: Preparing Variables
      id: prep-vars
      run: |
        echo "TF_KEY_STATE=${GITHUB_REPOSITORY#*/}" >> "$GITHUB_ENV"
        if [ "${{ env.BRANCH_NAME }}" = "main" ]; then
            echo "working on Prod"
            echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID_PROD }}" >> $GITHUB_ENV
            echo "TF_STATE_SA=${{ vars.TF_STATE_SA_PROD }}" >> $GITHUB_ENV
            echo "TF_CONTAINER_NAME=${{ vars.TF_CONTAINER_NAME_PROD }}" >> $GITHUB_ENV
            echo "TF_RG_NAME=${{ vars.TF_STATE_RG_PROD }}" >> $GITHUB_ENV
        else
            echo "working on Dev"
            echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}" >> $GITHUB_ENV
            echo "TF_STATE_SA=${{ vars.TF_STATE_SA_DEV }}" >> $GITHUB_ENV
            echo "TF_CONTAINER_NAME=${{ vars.TF_CONTAINER_NAME_DEV }}" >> "$GITHUB_ENV"
            echo "TF_RG_NAME=${{ vars.TF_STATE_RG_DEV }}" >> $GITHUB_ENV
        fi
      shell: bash
      
    - uses: Azure/login@v1
      with:
        creds: '{"clientId":"${{ vars.TEMP_CLIENT_ID }}","clientSecret":"${{ secrets.TEMP_SECRET }}","subscriptionId":"${{ vars.TEMP_SUBS_ID }}","tenantId":"${{ vars.TEMP_TENANT_ID }}"}'

    - name: Terraform Init
      id: tf-init
      run: |
        terraform init -backend-config=storage_account_name=${{ env.TF_STATE_SA }} \
          -backend-config=container_name=${{ env.TF_CONTAINER_NAME }} \
          -backend-config=resource_group_name=${{ env.TF_RG_NAME }} \
          -backend-config=key="${{ env.TF_KEY_STATE }}" \
          -backend-config=subscription_id=${{ vars.TEMP_SUBS_ID }} \
          -backend-config=tenant_id=${{ vars.TEMP_TENANT_ID }} \
          -backend-config=client_id=${{ vars.TEMP_CLIENT_ID }} \
          -backend-config=client_secret=${{ secrets.TEMP_SECRET }}
  
    # - name: Terraform Validate
    #   id: validate
    #   run: terraform validate -no-color

    - name: Terraform Plan
      id: tf-plan
      run: |
        export exitcode=0
        
        mkdir -p terraform-plan/${GITHUB_REPOSITORY#*/}

        terraform plan -detailed-exitcode -out terraform-plan/${GITHUB_REPOSITORY#*/}/${GITHUB_REPOSITORY#*/}-${{ env.BRANCH_NAME }}.tfplan || export exitcode=$?

        echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
        
        if [ $exitcode -eq 1 ]; then
          echo Terraform Plan Failed!
          exit 1
        else
          exit 0

        fi
    - uses: actions/upload-artifact@master
    with:
      name: ${GITHUB_REPOSITORY#*/}-${{ env.BRANCH_NAME }}.tfplan
      path: terraform-plan/${GITHUB_REPOSITORY#*/}

    - uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      env:
        PLAN: "terraform\n${{ steps.tf-plan.outputs.stdout }}"
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // 1. Retrieve existing bot comments for the PR
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          })
          const botComment = comments.find(comment => {
            return comment.user.type === 'Bot' && comment.body.includes('Terraform Format and Style')
          })
    
          // 2. Prepare format of the comment
          const output = `#### Terraform Plan ðŸ–Œ ðŸ¤– ðŸ“–  \`${{ steps.tf-plan.outcome }}\`
    
          <details><summary>Show Plan</summary>
    
          \`\`\`\n
          ${{ steps.tf-plan.outputs.plan }}
          \`\`\`
    
          </details>
    
          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
    
          // 3. If we have a comment, update it, otherwise create a new one
          if (botComment) {
            github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: output
            })
          } else {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
          }
